<!DOCTYPE html>
<html>
<head>
    <title>Mapas</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
     <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
     <script type="text/javascript" src="./mapResources/webgl-heatmap.js"></script>
     <script type="text/javascript" src="./mapResources/leaflet-webgl-heatmap.js"></script>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Thin:wght@100&display=swap" rel="stylesheet">
    
</head>
<style>
  #mapid {
      height: 800px;
      width: 100%;
  }

</style>
<header class="header" role="banner" id="header">
    <span class="general-nav-bar">
        <div class="logo-nav-bar">
            <!--Logo here-->
            <a class="logoBox" href="index.html">
                <img class="OzoneWardenLogo" src="images/OzoneWardenLogo.png" alt="Ozone Warden Logo">
            </a>
        </div>
        <div class="nav-bar">
            <!--menu button-->
            <button class="iconBtn" id="menuBtn">
                <!--hamburger menu--->
                <img class="menu-icon" src="images/icons/list.svg" alt="menu icon">
            </button>
        </div>
    </span>
    <!-- Menu-->
    <nav class="main-nav" id="menu">
        <!--Menu content-->
        <ul class="menu" >
            <li class="item-menu hover"><a href="index.html" target="" class="link-menu">Inicio</a></li>
            <li class="item-menu hover"><a href="dev.html" class="link-menu">Equipo</a></li>
            <li class="item-menu hover"><a href="contact.html" class="link-menu">Contacto</a></li>
            <li class="item-menu hover"><a href="Aplicacion.html" class="link-menu">Iniciar Sesión</a></li>
            <li class="item-menu hover"><a href="editarUsuario.html" class="link-menu">Editar Usuario</a></li>
            <li class="item-menu hover"><a href="mapas.html" class="link-menu">Mapa</a></li>
            <!--Menu content end-->
        </ul>
    </nav>
    <!--Menu end-->
</header>
<body>
    <button id="submitButton" onclick="restaurar()">normal</button>
        <label for="texto">Ingresa tu texto:</label>
        <input type="number" id="numero" placeholder="Escribe un numero">

        <button id="submitButton" onclick="sizeManipulator()">ajustar tamaño</button>
    
    <div id="mapid"></div>
  
    

    <style>
        #map {
            height: 800px;
            width: 100%;
        }

        #textInputContainer {
            text-align: center;
            padding: 10px;
        }
    </style>

    <script>
       // don't forget to include leaflet-heatmap.js

//Hola leopoldo del futuro esta es la guia de manejar leaflet heatmap
//leaflet heatmap requiere de index.js,heatmap.js y leaflet-heatmap.js
//los puntos los pones mediante testData
//los colores con gradient
//cambias el tamaño del ciruclo con radius *NO LO RECOMIENDO PORQUE AHORA ESTA BIEN*
//se puede ajustar la opacidad maxima y opacidad minima con maxOpacity y minOpacity respectivamente
//las propiedades center y zoom estan ajustadas para playa de gandia




var map = L.map('mapid', {
       center: [38.99592122004998, -0.16600370993846877],
       zoom: 12,
       minZoom: 8,
       });
   
   L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
           subdomains: 'abc'
       }).addTo(map);
var heatmap = L.webGLHeatmap({
       //boton que reduzca o aumente el size para distinguir de donde estan los valores
       size: 600,
       units: 'm',
       alphaRange: 0.4,
       gradientTexture:'verdeAzulRojo.png'
       
   });
   var testData = [
  [38.994935351205086, -0.1630294628697455, 122],
  [38.996506627357114, -0.16616833188428506, 51],
  [39.001950211119556, -0.15866192566452994, 51],
  [38.9951934988745, -0.15772476578614314, 51],
  [38.99044454914907, -0.16175850771725797, 70],
  [38.9913462604159, -0.15157542889469855, 60],
  [39.00327333340047, -0.16567546920402404, 50],
  [39.0014222594937, -0.16891976595151095, 50],
  [39.00692383559829, -0.16964198258526753, 50],
  [39.009570967845036, -0.1689402637659104, 50],
  [38.99294179926074, -0.165122074327554, 50],
  [38.985876355835764, -0.16242933771694143, 50],
  [38.99617236758804, -0.15513126576326267, 100],
  [38.9971408090036, -0.15170848755124233, 70],
  [38.99555827049106, -0.1721478632198201, 50],
  [38.99206776306875, -0.17293886655993765, 50],
  [38.9872022989057, -0.17014470074760563, 80],
  [38.979149102183456, -0.17060404268709747, 50],
  [38.99432263769214, -0.16435199095120828, 50],
  [38.99553233159583, -0.1641480398239923, 50],
  [38.99660329071318, -0.16478599991837672, 50]
];
var newPoints = generatePointsAround(testData);
heatmap.setData(newPoints);
heatmap.multiply(1.3);
update();
try {
       map.addLayer(heatmap);
   } catch (e) {
       throw e;
   }
function generatePointsAround(dataPoints) {
    //ESTO FUNCIONA CON CLIPS PAPEL Y CELO COMO SE TOQUE MINIMAMENTE ALGO SALDRAN DONUTS
    //lo mas importante es que numAdditionalPoints este en 1 
    //AVISADO QUEDAS VALUE ORIGINAL: 1,0.003,/100
    // Generate points in a randomly deformed circular pattern around each original point
        const newPoints = [];
        const numAdditionalPoints = 1;
        const baseRadius = 0.000001; // Adjust the base radius as needed

        for (let i = 0; i < dataPoints.length; i++) {
            const [lat, lng, originalIntensity] = dataPoints[i];

            for (let j = 0; j < numAdditionalPoints; j++) {
            // Generate points in a deformed circular pattern with random radius variations
            const randomRadiusVariation = 0.001 * 0.001; // Adjust the variation range as needed
            const randomAngle = 0.001 * 2 * Math.PI;

            // Calculate coordinates based on polar coordinates with random variations
            const newLat = lat + (baseRadius + randomRadiusVariation) * Math.cos(randomAngle);
            const newLng = lng + (baseRadius + randomRadiusVariation) * Math.sin(randomAngle);

            // Calculate intensity for the new point based on the original intensity
            const intensity = originalIntensity / 200;

            // Add new point with adjusted intensity and randomly deformed coordinates
            newPoints.push([newLat, newLng, intensity]);
            }
        }

        return newPoints;
        }

//meter los datos del servidor... SALVAME DONALD TRUMP SALVAME!
            //transforma los estupidos datos de los cojones en algo usable para chad mapa
            function transformarDatos(lugar) {
              // Dividir el string en las coordenadas usando la coma como separador
              var coordenadasArray = lugar.split(',');

              // Obtener las coordenadas en variables separadas
              var lat = parseFloat(coordenadasArray[0]);
              var lng = parseFloat(coordenadasArray[1]);

              console.log("LATITUD: " + lat);
              console.log("LONGITUD: " + lng);
                  return {
                      lat, 
                      lng
                  };

            };
            
            //ASI ES MARIO CLIMENT YO METO TUS ESTUPIDAS FUNCIONES EN MI PAGINA YO SOY MEJOR MAYRO YO!!!
            function obtenerMediciones(cb) {
              var xmlhttp = new XMLHttpRequest();
              xmlhttp.onreadystatechange = function () {
                  if (this.readyState == 4 && this.status == 200) {
                      try {
                          console.log("Recibo: " + this.responseText);
                          var medicionesData = JSON.parse(this.responseText);
                          console.log("Parse result: " + medicionesData);
                          cb(medicionesData);
                      } catch (error) {
                          console.error("Error al analizar JSON:", error);
                      }
                  }
              };

              xmlhttp.open("GET", "../rest/measure/all/data", true);
              xmlhttp.send();
            }
            
    function update() {
        obtenerMediciones(function (mediciones) {
            var transformedTestData = [];

          mediciones.forEach((medicion) => {
            console.log("ITERANDO: " + medicion.idMedicion);
            console.log("LUGAR: " + medicion.lugar);
            console.log("VALOR: " + medicion.valor);

            lugar = transformarDatos(medicion.lugar);
            var dataEntry = [lugar.lat, lugar.lng, medicion.valor];

            transformedTestData.push(dataEntry);
          });
            
          heatmapLayer.setData(jsonData);

        });
    }







    </script>
    <script>
        function restaurar(){
         heatmapLayer.setData(testData);
        }
        function high() {
          var testDatanuevo = filtro(testData,3);
          heatmapLayer.setData(testDatanuevo);
        }
        function filtro(datos,valor) {
        var datosFiltrados = datos.data.filter(function(elemento) {
          return elemento.count >= valor;
        });
        return {
          data: datosFiltrados
        };
        }
        function clearHeatmap(mapa){
            mapa.clear();
        }
        function upload(mapa){
            var newPoints = generatePointsAround(testData);
            mapa.setData(newPoints);
            mapa.multiply(1.3);
        }
        //funcion para el saber donde estan los puntos/sizear los puntos del mapa de calor
        function sizeManipulator(){
           var sizeH = document.getElementById('numero').value;
           if (!isNaN(sizeH) && sizeH !== '') {
                heatmap.size=sizeH;
                heatmap.clear();
                upload(heatmap);
            } else {
                alert('Por favor, ingresa un valor numérico válido en el campo de número.');
            }
           
        }
      
          
          



    </script>
   <script>
    //ACCEDER A LA ESTACION
    //Accede al get que se envia a informacion sobre la estacion de madrid
    //por alguna demoniaca razon no envia los datos sino un link a los datos y por eso existe fetchearOzono
    //quiero suicidarme... pero las ganas de matar al creador de aemet me mantiene vivo
    var data = null;
    var xhr = new XMLHttpRequest();
    xhr.withCredentials = true;

    xhr.addEventListener("readystatechange", function () {
      if (this.readyState === 4) {
        console.log(this.responseText);
        var jsonData = JSON.parse(this.responseText);
        var datosUrl = jsonData.datos;
        console.log(datosUrl)
        fetchearOzono(datosUrl);
      }
    });

    xhr.open("GET", "https://opendata.aemet.es/opendata/api/red/especial/perfilozono/estacion/peninsula/?api_key=eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJyb2tvaGFzdGVyQGdtYWlsLmNvbSIsImp0aSI6ImFjMzdmMjdhLTk4NGQtNDlhOS04MmNmLTIwZjU5MWM5YTA3MyIsImlzcyI6IkFFTUVUIiwiaWF0IjoxNzAyNTc3NDcyLCJ1c2VySWQiOiJhYzM3ZjI3YS05ODRkLTQ5YTktODJjZi0yMGY1OTFjOWEwNzMiLCJyb2xlIjoiIn0.K7oFsg9_p9NnqgTF_91PUB0988dL1M53NCmAqNaMKQ4");
    xhr.setRequestHeader("cache-control", "no-cache");
    xhr.send(data);
    //FUNCION QUE COGE EL URL AGARRADO POR EL GET E INTENTA SACAR EL VALOR INTEGRATEDOZONE
    // Y EL VALOR RESIDUAL OZONE.. de momento solo saca el integrated ozone
    // luego pone el integrated ozone en un marker en madrid

    function fetchearOzono(url){
      fetch(url)
      .then(response => response.text())
      .then(html => {
        // Log the HTML data to the console

                
            

        // Use regular expressions to find the desired numbers
        var integratedOzoneMatch = html.match(/Integrated Ozone \[DU\]:\s*([\d.]+)/);
        var residualOzoneMatch = html.match(/Residual Ozone\s*\[DU\]:\s*([\d.]+)/);
        

        // Check if matches were found and extract the numbers
        if (integratedOzoneMatch && residualOzoneMatch) {
            var integratedOzoneValue = parseFloat(integratedOzoneMatch[1]);
            console.log("Integrated Ozone:", integratedOzoneValue);
            var marker = L.marker([40.42697795042544, -3.698073083157613]).addTo(map);
            
            var residualOzoneValue = parseFloat(residualOzoneMatch[1]);
            console.log("Residual Ozone:", residualOzoneValue);
            marker.bindPopup("Valor del ozono = " + integratedOzoneValue.toString() + " Dobsons<br> Valor del ozono Residual = "+residualOzoneValue.toString() + " Dobsons");
        }
              })
              .catch(error => console.error('Error fetching data:', error));
            }
   
   
  </script>
   </script> 
</body>
</html>
